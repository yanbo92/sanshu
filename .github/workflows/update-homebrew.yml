name: æ›´æ–° Homebrew é…æ–¹

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag_name:
        description: å‘å¸ƒæ ‡ç­¾åç§° (ä¾‹å¦‚ v0.2.3)
        required: true
        type: string

jobs:
  update-homebrew:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      - name: è·å–å‘å¸ƒä¿¡æ¯
        id: release_info
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            TAG_NAME="${{ github.event.release.tag_name }}"
          else
            TAG_NAME="${{ github.event.inputs.tag_name }}"
          fi

          VERSION_NUMBER=${TAG_NAME#v}
          echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "version_number=${VERSION_NUMBER}" >> $GITHUB_OUTPUT
          echo "Release tag: ${TAG_NAME}"
          echo "Version number: ${VERSION_NUMBER}"

      - name: éªŒè¯å‘å¸ƒèµ„æºæ˜¯å¦å­˜åœ¨
        run: |
          TAG_NAME="${{ steps.release_info.outputs.tag_name }}"
          VERSION_NUMBER="${{ steps.release_info.outputs.version_number }}"

          # æ£€æŸ¥ release assets æ˜¯å¦å­˜åœ¨
          # URL æ ¼å¼ï¼š/download/{TAG_NAME}/sanshu-cli-{TAG_NAME}-{platform}.tar.gz
          INTEL_URL="https://github.com/yuaotian/sanshu/releases/download/${TAG_NAME}/sanshu-cli-${TAG_NAME}-macos-x86_64.tar.gz"
          ARM_URL="https://github.com/yuaotian/sanshu/releases/download/${TAG_NAME}/sanshu-cli-${TAG_NAME}-macos-aarch64.tar.gz"

          echo "Checking Intel asset: $INTEL_URL"
          if ! curl --head --fail "$INTEL_URL" > /dev/null 2>&1; then
            echo "âŒ Intel asset not found: $INTEL_URL"
            exit 1
          fi

          echo "Checking ARM asset: $ARM_URL"
          if ! curl --head --fail "$ARM_URL" > /dev/null 2>&1; then
            echo "âŒ ARM asset not found: $ARM_URL"
            exit 1
          fi

          echo "âœ… All release assets verified"

      - name: è®¡ç®—å‘å¸ƒèµ„æºçš„ SHA256
        id: sha256
        run: |
          TAG_NAME="${{ steps.release_info.outputs.tag_name }}"
          VERSION_NUMBER="${{ steps.release_info.outputs.version_number }}"

          INTEL_URL="https://github.com/yuaotian/sanshu/releases/download/${TAG_NAME}/sanshu-cli-${TAG_NAME}-macos-x86_64.tar.gz"
          ARM_URL="https://github.com/yuaotian/sanshu/releases/download/${TAG_NAME}/sanshu-cli-${TAG_NAME}-macos-aarch64.tar.gz"

          echo "Downloading and calculating SHA256..."

          # ä¸‹è½½å¹¶è®¡ç®— SHA256
          curl -L -o /tmp/intel.tar.gz "$INTEL_URL"
          curl -L -o /tmp/arm.tar.gz "$ARM_URL"

          INTEL_SHA256=$(sha256sum /tmp/intel.tar.gz | cut -d' ' -f1)
          ARM_SHA256=$(sha256sum /tmp/arm.tar.gz | cut -d' ' -f1)

          echo "intel_sha256=${INTEL_SHA256}" >> $GITHUB_OUTPUT
          echo "arm_sha256=${ARM_SHA256}" >> $GITHUB_OUTPUT
          echo "intel_url=${INTEL_URL}" >> $GITHUB_OUTPUT
          echo "arm_url=${ARM_URL}" >> $GITHUB_OUTPUT

          echo "Intel SHA256: $INTEL_SHA256"
          echo "ARM SHA256: $ARM_SHA256"

      - name: æ£€å‡º homebrew-sanshu ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: yuaotian/homebrew-sanshu
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          path: homebrew-tap

      - name: é…ç½® homebrew-tap çš„ Git
        run: |
          cd homebrew-tap
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"

      - name: æ›´æ–° Homebrew é…æ–¹
        run: |
          TAG_NAME="${{ steps.release_info.outputs.tag_name }}"
          VERSION_NUMBER="${{ steps.release_info.outputs.version_number }}"
          INTEL_SHA256="${{ steps.sha256.outputs.intel_sha256 }}"
          ARM_SHA256="${{ steps.sha256.outputs.arm_sha256 }}"
          INTEL_URL="${{ steps.sha256.outputs.intel_url }}"
          ARM_URL="${{ steps.sha256.outputs.arm_url }}"

          cd homebrew-tap

          # ç¡®ä¿ Formula æ–‡ä»¶å­˜åœ¨
          if [[ ! -f "Formula/sanshu.rb" ]]; then
            echo "âŒ Error: Formula/sanshu.rb not found in tap repository"
            exit 1
          fi

          echo "Updating Formula with:"
          echo "  Version: ${VERSION_NUMBER}"
          echo "  Intel URL: ${INTEL_URL}"
          echo "  Intel SHA256: ${INTEL_SHA256}"
          echo "  ARM URL: ${ARM_URL}"
          echo "  ARM SHA256: ${ARM_SHA256}"

          # æ›´æ–°ç‰ˆæœ¬å·
          sed -i "s|version \".*\"|version \"${VERSION_NUMBER}\"|g" Formula/sanshu.rb

          # æ›´æ–° Intel ç‰ˆæœ¬çš„ URL å’Œ SHA256ï¼ˆé€‚é…æ–°çš„ on_intel è¯­æ³•ï¼‰
          sed -i "s|https://github.com/yuaotian/sanshu/releases/download/v[0-9.]*/sanshu-cli-v[0-9.]*-macos-x86_64.tar.gz|${INTEL_URL}|g" Formula/sanshu.rb
          sed -i "/on_intel do/,/end/ { /sha256/ s|sha256[[:space:]]*\".*\"|sha256  \"${INTEL_SHA256}\"|; }" Formula/sanshu.rb

          # æ›´æ–° ARM ç‰ˆæœ¬çš„ URL å’Œ SHA256ï¼ˆé€‚é…æ–°çš„ on_arm è¯­æ³•ï¼‰
          sed -i "s|https://github.com/yuaotian/sanshu/releases/download/v[0-9.]*/sanshu-cli-v[0-9.]*-macos-aarch64.tar.gz|${ARM_URL}|g" Formula/sanshu.rb
          sed -i "/on_arm do/,/end/ { /sha256/ s|sha256[[:space:]]*\".*\"|sha256  \"${ARM_SHA256}\"|; }" Formula/sanshu.rb

      - name: éªŒè¯é…æ–¹æ›´æ”¹
        run: |
          cd homebrew-tap

          echo "=== Formula changes ==="
          git diff Formula/sanshu.rb || true

          echo "=== Updated Formula content ==="
          cat Formula/sanshu.rb

      - name: æäº¤å¹¶æ¨é€åˆ° homebrew-sanshu ä»“åº“
        run: |
          TAG_NAME="${{ steps.release_info.outputs.tag_name }}"
          VERSION_NUMBER="${{ steps.release_info.outputs.version_number }}"
          cd homebrew-tap

          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --quiet Formula/sanshu.rb; then
            echo "No changes to Formula, skipping commit"
            exit 0
          fi

          # æäº¤å¹¶æ¨é€æ›´æ”¹
          git add Formula/sanshu.rb
          git commit -m "chore: update formula to ${TAG_NAME}

          - Update version to ${VERSION_NUMBER}
          - Update download URLs and SHA256 checksums
          - Auto-generated by update-homebrew workflow"

          git push origin main
          echo "âœ… Successfully updated homebrew-sanshu repository"

      - name: æµ‹è¯•é…æ–¹ (å¯é€‰)
        run: |
          echo "ğŸ§ª Formula update completed successfully!"
          echo "You can test the formula with:"
          echo "  brew tap yuaotian/sanshu"
          echo "  brew install sanshu"
