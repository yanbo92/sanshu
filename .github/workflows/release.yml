name: å‘å¸ƒæµç¨‹ (Release Pipeline)

on:
  # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼šç”¨äºå‘å¸ƒæ–°ç‰ˆæœ¬ï¼ˆåŒ…å«è‡ªåŠ¨ç‰ˆæœ¬å‡çº§ã€æ‰“æ ‡ç­¾ã€æ„å»ºå’Œå‘å¸ƒï¼‰
  workflow_dispatch:
    inputs:
      version_type:
        description: 'ç‰ˆæœ¬ç±»å‹ (patch=ä¿®å¤, minor=åŠŸèƒ½, major=é‡å¤§å˜æ›´)'
        required: true
        default: patch
        type: choice
        options:
          - patch
          - minor
          - major
          - custom
      custom_version:
        description: 'è‡ªå®šä¹‰ç‰ˆæœ¬å· (æ ¼å¼: x.y.z, ä»…å½“ç±»å‹é€‰ä¸º custom æ—¶æœ‰æ•ˆ)'
        required: false
        type: string

  # å…è®¸ Tag è§¦å‘ï¼šç”¨äºé‡æ–°æ„å»ºæˆ–æ‰‹åŠ¨æ‰“ Tag åçš„å‘å¸ƒ
  push:
    tags: ['v*']

jobs:
  # -----------------------------------------------------------------------------
  # é˜¶æ®µ 1: å‡†å¤‡å‘å¸ƒ (ç‰ˆæœ¬ç®¡ç† & æ ‡ç­¾)
  # -----------------------------------------------------------------------------
  prepare:
    name: å‡†å¤‡å‘å¸ƒ
    runs-on: ubuntu-latest
    permissions:
      contents: write # éœ€è¦å†™å…¥æƒé™æ¥æ¨é€ Tag
    outputs:
      version: ${{ steps.determine_version.outputs.version }}
      tag_name: ${{ steps.determine_version.outputs.tag_name }}
      should_build: ${{ steps.check_trigger.outputs.should_build }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: é…ç½® Git ç”¨æˆ·
        if: github.event_name == 'workflow_dispatch'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ç¡®å®šç‰ˆæœ¬å·
        id: determine_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # --- æ‰‹åŠ¨è§¦å‘é€»è¾‘ï¼šè®¡ç®—æ–°ç‰ˆæœ¬ ---

            # 1. è·å–å½“å‰ç‰ˆæœ¬
            if [ -f "Cargo.toml" ]; then
              CURRENT_VERSION=$(grep '^version = ' Cargo.toml | head -1 | cut -d'"' -f2)
            else
              CURRENT_VERSION="0.0.0"
            fi
            echo "Current version: $CURRENT_VERSION"

            # 2. è®¡ç®—æ–°ç‰ˆæœ¬
            TYPE="${{ inputs.version_type }}"
            CUSTOM="${{ inputs.custom_version }}"

            if [ "$TYPE" = "custom" ]; then
              if [ -z "$CUSTOM" ]; then
                echo "Error: Custom version is required when type is 'custom'"
                exit 1
              fi
              NEW_VERSION="$CUSTOM"
            else
              IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
              case $TYPE in
                "major") major=$((major + 1)); minor=0; patch=0 ;;
                "minor") minor=$((minor + 1)); patch=0 ;;
                "patch") patch=$((patch + 1)) ;;
              esac
              NEW_VERSION="$major.$minor.$patch"
            fi

            echo "New version: $NEW_VERSION"
            echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "tag_name=v$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "is_new_release=true" >> $GITHUB_OUTPUT

          else
            # --- Tag è§¦å‘é€»è¾‘ï¼šä½¿ç”¨ç°æœ‰ Tag ---
            TAG_NAME="${{ github.ref_name }}"
            VERSION=${TAG_NAME#v}
            echo "Triggered by tag: $TAG_NAME"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
            echo "is_new_release=false" >> $GITHUB_OUTPUT
          fi

      - name: æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶å¹¶æ¨é€ (ä»…æ‰‹åŠ¨è§¦å‘)
        if: github.event_name == 'workflow_dispatch'
        run: |
          NEW_VERSION="${{ steps.determine_version.outputs.version }}"
          TAG_NAME="${{ steps.determine_version.outputs.tag_name }}"
          CURRENT_DATE=$(date +"%Y-%m-%d")

          echo "Updating files to version $NEW_VERSION..."

          # æ›´æ–° Cargo.toml
          if [ -f "Cargo.toml" ]; then
            sed -i.bak "s/^version = \"[^\"]*\"/version = \"$NEW_VERSION\"/" Cargo.toml && rm Cargo.toml.bak
          fi

          # æ›´æ–° package.json
          if [ -f "package.json" ]; then
            sed -i.bak "s/\"version\"[[:space:]]*:[[:space:]]*\"[^\"]*\"/\"version\": \"$NEW_VERSION\"/" package.json && rm package.json.bak
          fi

          # æ›´æ–° tauri.conf.json
          if [ -f "tauri.conf.json" ]; then
            sed -i.bak "s/\"version\"[[:space:]]*:[[:space:]]*\"[^\"]*\"/\"version\": \"$NEW_VERSION\"/" tauri.conf.json && rm tauri.conf.json.bak
          fi

          # æ›´æ–° version.json
          if [ -f "version.json" ]; then
            sed -i.bak "s/\"version\"[[:space:]]*:[[:space:]]*\"[^\"]*\"/\"version\": \"$NEW_VERSION\"/" version.json && rm version.json.bak
            sed -i.bak "s/\"build_date\"[[:space:]]*:[[:space:]]*\"[^\"]*\"/\"build_date\": \"$CURRENT_DATE\"/" version.json && rm version.json.bak
          fi

          # æäº¤å¹¶æ¨é€
          git add .
          git commit -m "release: Release $NEW_VERSION"
          git tag -a "$TAG_NAME" -m "Release $NEW_VERSION"

          echo "Pushing changes and tag..."
          git push origin main
          git push origin "$TAG_NAME"

  # -----------------------------------------------------------------------------
  # é˜¶æ®µ 2: å¤šå¹³å°æ„å»º (Build)
  # -----------------------------------------------------------------------------
  build:
    name: æ„å»º CLI (${{ matrix.name }})
    needs: prepare
    runs-on: ${{ matrix.platform }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            args: --target aarch64-apple-darwin
            name: macos-aarch64
          - platform: macos-latest
            args: --target x86_64-apple-darwin
            name: macos-x86_64
          - platform: ubuntu-22.04
            args: ''
            name: linux-x86_64
          - platform: windows-latest
            args: ''
            name: windows-x86_64

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          # å…³é”®ï¼šæ£€å‡ºç‰¹å®šçš„ Tagï¼Œç¡®ä¿æ‰€æœ‰æ„å»ºæœºå™¨ä½¿ç”¨ç›¸åŒçš„ä»£ç çŠ¶æ€
          ref: ${{ needs.prepare.outputs.tag_name }}

      - name: å®‰è£… Linux ç³»ç»Ÿä¾èµ–
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf pkg-config \
            libglib2.0-dev libgtk-3-dev libgdk-pixbuf2.0-dev libpango1.0-dev libatk1.0-dev \
            libcairo-gobject2 libjavascriptcoregtk-4.1-dev libasound2-dev libpulse-dev libjack-dev

      - name: å®‰è£… Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v4

      - name: å®‰è£… Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          # macOS éœ€è¦åŒæ—¶å®‰è£… x86_64 å’Œ aarch64 target
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: é…ç½® Rust ç¼“å­˜
        uses: swatinem/rust-cache@v2

      - name: å®‰è£…å‰ç«¯ä¾èµ–
        run: pnpm install

      - name: å®‰è£… Tauri CLI
        run: cargo install tauri-cli --version "^2.0" --locked

      - name: æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶
        shell: bash
        run: |
          echo "Building for ${{ matrix.name }}..."
          if [[ "${{ matrix.platform }}" == "macos-latest" ]]; then
            cargo tauri build ${{ matrix.args }} --no-bundle
          else
            cargo tauri build --no-bundle
          fi

      - name: æ‰“åŒ…äº§ç‰©
        shell: bash
        run: |
          mkdir -p cli-package
          TAG_NAME="${{ needs.prepare.outputs.tag_name }}"

          # ç¡®å®šäº§ç‰©è·¯å¾„
          if [[ "${{ matrix.platform }}" == "macos-latest" ]]; then
            if [[ "${{ matrix.args }}" == *"aarch64"* ]]; then
              TARGET_DIR="target/aarch64-apple-darwin/release"
            else
              TARGET_DIR="target/x86_64-apple-darwin/release"
            fi
          else
            TARGET_DIR="target/release"
          fi

          # å¤åˆ¶å¹¶å‹ç¼©
          if [[ "${{ matrix.platform }}" == "windows-latest" ]]; then
            cp "$TARGET_DIR/ç­‰ä¸€ä¸‹.exe" cli-package/
            cp "$TARGET_DIR/ä¸‰æœ¯.exe" cli-package/
            cd cli-package
            7z a ../sanshu-cli-${TAG_NAME}-${{ matrix.name }}.zip *
          else
            cp "$TARGET_DIR/ç­‰ä¸€ä¸‹" cli-package/
            cp "$TARGET_DIR/ä¸‰æœ¯" cli-package/
            cd cli-package
            tar -czf ../sanshu-cli-${TAG_NAME}-${{ matrix.name }}.tar.gz *
          fi

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: sanshu-cli-${{ matrix.name }}
          path: |
            sanshu-cli-*.tar.gz
            sanshu-cli-*.zip
          if-no-files-found: error

  # -----------------------------------------------------------------------------
  # é˜¶æ®µ 3: å‘å¸ƒ (Publish)
  # -----------------------------------------------------------------------------
  release:
    name: å‘å¸ƒ Release
    needs: [prepare, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.prepare.outputs.tag_name }}

      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: å®‰è£… git-cliff (ç”¨äºç”Ÿæˆ Changelog)
        uses: taiki-e/install-action@git-cliff

      - name: ç”Ÿæˆ Changelog
        id: changelog
        run: |
          TAG_NAME="${{ needs.prepare.outputs.tag_name }}"

          # å°è¯•è·å–ä¸Šä¸€ä¸ª Tag
          PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -E '^v[0-9]+' | grep -A 1 "^$TAG_NAME$" | tail -n 1 || echo "")

          echo "Generating changelog for $TAG_NAME (Previous: $PREVIOUS_TAG)"

          if [ -z "$PREVIOUS_TAG" ] || [ "$PREVIOUS_TAG" == "$TAG_NAME" ]; then
            git-cliff --tag "$TAG_NAME" --output changelog.md
          else
            git-cliff "$PREVIOUS_TAG..$TAG_NAME" --output changelog.md
          fi

          # ç”Ÿæˆå‘å¸ƒæ ‡é¢˜ (æå–ä¸»è¦ç‰¹æ€§)
          VERSION=${TAG_NAME#v}
          if [ -n "$PREVIOUS_TAG" ]; then
            MAIN_FEATURE=$(git log --oneline "$PREVIOUS_TAG..$TAG_NAME" | grep -E "^[a-f0-9]+ (feat|fix)" | head -1 | sed 's/^[a-f0-9]* //' | sed 's/^feat: /âœ¨ /' | sed 's/^fix: /ğŸ /')
          fi

          if [ -z "$MAIN_FEATURE" ]; then
             echo "release_title=$VERSION ğŸ“¦ ç‰ˆæœ¬æ›´æ–°" >> $GITHUB_OUTPUT
          else
             echo "release_title=$VERSION $MAIN_FEATURE" >> $GITHUB_OUTPUT
          fi

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.prepare.outputs.tag_name }}
          name: ${{ steps.changelog.outputs.release_title }}
          body_path: changelog.md
          draft: false
          prerelease: false
          files: |
            artifacts/*/sanshu-cli-*.tar.gz
            artifacts/*/sanshu-cli-*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: è§¦å‘ Homebrew æ›´æ–°
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            console.log('Triggering Homebrew update...');
            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'update-homebrew.yml',
                ref: 'main',
                inputs: { tag_name: '${{ needs.prepare.outputs.tag_name }}' }
              });
              console.log('âœ… Homebrew update triggered');
            } catch (error) {
              console.error('âš ï¸ Could not trigger Homebrew update:', error);
            }
